generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  ADMIN
}

enum TransactionStatus {
  PENDING
  ACCEPTED
  REJECTED
  RETURNED
  CANCELLED
}

enum DocumentStatus {
  ACTIVE
  ARCHIVED
}

enum DocumentActionType {
  CREATE
  SEND
  ACCEPT
  RETURN
  ARCHIVE
  UNARCHIVE
}

model User {
  id         String   @id // Supabase Auth user ID
  fullName   String
  email      String   @unique
  department String?
  role       Role     @default(USER)
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())

  sentTransactions     Transaction[]  @relation("FromUser")
  receivedTransactions Transaction[]  @relation("ToUser")
  holdingDocuments     Document[]     @relation("DocumentCurrentHolder")
  archivedDocuments    Document[]     @relation("ArchivedBy")
  documentNotes        DocumentNote[]
}

model Document {
  number          String  @id
  currentHolderId String?
  currentHolder   User?   @relation("DocumentCurrentHolder", fields: [currentHolderId], references: [id])

  status           DocumentStatus @default(ACTIVE)
  archivedAt       DateTime?
  archivedByUserId String?
  archivedBy       User?          @relation("ArchivedBy", fields: [archivedByUserId], references: [id])

  archiveDepartment String?
  archiveNote       String?

  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  notes     DocumentNote[]
}

model DocumentNote {
  id              String            @id @default(uuid())
  documentNumber  String
  transactionId   String?
  actionType      DocumentActionType
  note            String
  createdByUserId String
  createdAt       DateTime          @default(now())

  document    Document     @relation(fields: [documentNumber], references: [number])
  transaction Transaction? @relation(fields: [transactionId], references: [id])
  createdBy   User         @relation(fields: [createdByUserId], references: [id])

  @@index([documentNumber])
  @@index([transactionId])
}

model Transaction {
  id             String            @id @default(uuid())
  documentNumber String
  fromUserId     String
  toUserId       String
  status         TransactionStatus @default(PENDING)
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  fromUser User          @relation("FromUser", fields: [fromUserId], references: [id])
  toUser   User          @relation("ToUser", fields: [toUserId], references: [id])
  notes    DocumentNote[]

  @@index([documentNumber])
  @@index([toUserId])
  @@index([fromUserId])
  @@index([status])
}
